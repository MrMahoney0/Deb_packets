# Deb Пакеты
Сегодня я расскажу на абстрактном примере как правильно создать deb (package.deb) пакет для Ubuntu/Debian. Пакет мы будем делать бинарный. Пакеты, компилирующие бинарники из исходников здесь не рассматриваются: осилив изложенные ниже знания, в дальнейшем по готовым примерам можно понять суть и действовать по аналогии.
___
 _deb (сокращение от Debian) — расширение имён файлов «бинарных» пакетов для распространения и установки программного обеспечения в операционной системе проекта Debian, и других, использующих систему управления пакетами dpkg._
___

_dpkg — это программное обеспечение, являющееся основой системы управления пакетами в Debian и ряде других операционных систем, основанных на Debian, например Ubuntu. dpkg используется для установки, удаления, и получения информации о .deb пакетах._

___

####Что нам нужно для создания *.Deb пакетов?
#####Рассмотрим на примере линукс

Конечно, для создания полноценного пакета хватит архиваторов tar, gz, ar, но можно исключить лишнюю возню, и воспользоваться инструментами, созданными для облегчения жизни :)
___
####Шаг 1:
Нам нужен архиватор dpkg, для этого открываем терминал линукс и набираем следуюущую команду

```
sudo apt-get install dpkg debconf debhelper lintian
```
___
####Шаг 2: 
Создадим на языке Python небольшую программу. На нешем примере она будет называться __Hello world__, но вы можете называть её как вам вздумается.

Для этого открываем терминал Linux и набираем команду:

```
 mkdir Hello world
```
Затем открываем его
```
cd Hello world
```
В этой папке собственно, нам и нужно будет написать  программу на Языке Python

Далее открываем текстовый редактор(___В моем случае nano___) командой:

```
nano hello.py
```
В отобразившемся окне напишем:
```
print("Hello World!")

```
Затем нажимаем Ctrl + X; Нажимаем y(___yes___); и нажимаем Enter.

>Для выполнения программы нам необходимо набрать команду ___python3 hello.py (название файла)___
___

####Шаг 3:
В домашнем каталоге (или где удобно) создаём папку, в которой будут лежать все файлы будущего пакета: mkdir ~/supersh. Далее будем называть её корень пакета.
В корне пакета создаём папку «DEBIAN» (заглавными буквами, это важно!). Эта папка содержит управляющую генерацией пакета информацию, и не копируется на диск при установке пакета.
Также корневая папка пакета содержит будущий «корень диска»: при установке пакета все файлы (кроме папки «debian») распаковываются в корень /. поэтому наш скрипт должен лежать по такому пути, относительно корня пакета: «usr/bin/super.sh»

Для этого создаем 2 каталога в терминале линукс командой:
```
mkdir -p /supersh/DEBIAN # управляющая папка
mkdir -p /supersh/usr/bin # путь к скрипту

```
__supersh__ - название каталога в которм хранятся 2 папки __usr__ и __DEBIAN__ 

После создания нужных нам каталогов нам нужно скопировать наш скрипт в папку __supersh/usr/bin/__
```
cp hello.py /supersh/usr/bin/ # копируем наш скрипт в нужное место
```
В итоге у нас есть:
>supersh/DEBIAN/
supersh/usr/
supersh/usr/bin/
supersh/usr/bin/hello.py
---
####Шаг 4:

__Создание пакета: DEBIAN/*__

Как уже было сказано выше, папка _DEBIAN_ содержит файлы, используемые при установке. Здесь я опишу (с примерами) каждый файл.
Для создания полноценного пакета достаточно контрольного файла __«control»__, все остальные используются либо для прикрепления текстовой информации (__changelog__, лицензия), либо для управления расширенными возможностями установки приложений.
Из описанных ниже файлов в папке _DEBIAN/*_ выбираем необходимые, и заполняем согласно инструкции 
В наше примере реально используется только обязательный __DEBIAN/control.__

__DEBIAN/control: Основная информация__
__control__ — центральный файл пакета, описывающего все основные свойства. Файл — текстовый, состоящий из пар «Атрибут: значение».
В таблице приведены все поля, определённые для контрольного файла. Обязательные поля выделены жирным: без них пакет не будет считаться составленным верно.

Атрибут       | Описание   |  Примеры                     
:-------------|:---------:|-------------:
 __Package__: |     Имя пакета: [a-zA-Z0-9-] — только латиница, цифры, и дефис. Имя используется при установке: apt-get install "package".     |  __Package:__ hello 
__Version:__ | Версия пакета (и проги внутри). Используется <<обновлять ли>>. Рекомендуется __всегда__ указывать версию пакета: при изменении структуры пакета цифра увеличивается на единичку. | __Version:__ 1.0-1<bl>Version: 2009.12.12-1 
Provides| Имя приложения (возможно, виртуальное), регистрируемое в системе в результате установки этого пакета. Используется редко: в основном, если нужно изменить имя пакета, или если более одного пакета предлагают одинаковый функционал. Например, пакеты Apache и nginx предоставляют возможность демона httpd.|Provides: hello
__Maintainer__| Имя и почта мэйнтейнера пакета: человека, который «дебианизировал» приложение.Формат произвольный, но принято имя __(Электронная почта)__. Иными словами  __Maintainer__ указывает кто собрал этот пакет и кто отвечает за его поддержку.|__Maintainer:__ example@mail.com
__Architecture__|Архитектура процессора, для которой предназначен пакет.Допустимые значения: __i386, amd64, all, source__.По дефолту указывается стоит __all__|__Architecture:__ all
__Section__|Категория пакета, позволяет определить зачем он нужен.|__Section:__ example
__Description__|Краткое описание пакета.Описание состоит из двух частей: короткое описание (70 символов) на той же строке, и длинное описание на последующих строках, начинающихся с пробела.|__Description:__ Short.<br>␣Long <br>␣goes here.<br>␣.<br>␣New line.
|       |__-Связи и зависимости-__|
Depends|От каких пакетов зависит ваш пакет, он не может быть установлен, пока не установлены эти пакеты.|Depends: example
Pre-Depends|Список пакетов, которые требуются в процессе установки этого пакета.Эти зависимости могут потребоваться для скриптов установки пакета: например, пакет flash-installer требует wget.Можно использовать ограничения на версию.|Pre-Depends: wget (>= 1.0)
Conflicts|Список пакетов, которые не могут быть установлены одновременно с этим.Установка не удастся, если хоть один из перечисленных пакетов уже будет установлен.|Conflicts: example
Replaces|	Список пакетов, файлы которых модифицируются этим пакетом.Требуется в случае создания «пакета-патча», изменяющего что-либо: в противном случае при замене файлов чужого пакета возникнет ошибка при установке.|Replaces: example
Recommends|Список пакетов, рекомендуемых к установке.Эти пакеты не обязательны, но обычно используются вместе с текущим|Recommends: example
Suggests|Список пакетов, предлагаемых к установке.Эти пакеты не обязательны, но с ними прога работает ещё лучше. По идее, менеджер пакетов должен предлагать установить их.|Suggests: example
Build-Depends|(Только для Architecture: source).Список пакетов, требуемых для компиляции исходников.То же, что и Depends, но логически отделено.|Build-Depends: example
|            |__-Экстра-__|
Installed-Size|Размер файлов пакета в килобайтах.Просто цифра, округлённая до ближайшего целого. Используется менеджером пакетов для определения суммарного требуемого объёма на диске.|Installed-Size: example
Priority|Важность пакета, для новых пакетов, которые ни с чем не конфликтуют обычно прописывают optional, кроме того доступны значения required, important или standard (такие пакеты не удаляются вообще!).|Priority: optional
Esssential|Если установить этот атрибут в значение «yes», пакет нельзя будет удалить.|Esssential: yes
Origin|Строка: откуда получены программы в пакете. Обычно используется URL сайта автора, почта или имя.|Origin: example
X-Source|Полная ссылка на *.tar.gz архив с исходниками| X-Source: ...*.tgz

___
####Шаг 5: Создание Манифеста
Как уже было сказано выше в каждом deb пакете содержаться не только файлы самой программы, но и файл манифеста, в котором описан пакет, его зависимости и параметры. Этот файл имеет название __control__ и должен находится в папке _DEBIAN_. Для сборки пакета будем использовать папку _supersh_, чтобы файлы программы не путались с исходными файлами и те не попали в пакет. 

Первым делом надо посмотреть размер файлов программы, поскольку в данном случае файл один, достаточно посмотреть его размер для заполнения __control__.

Для этого набираем команду в терминале:
```
du -k ./hello.py
```
Если файлов несколько, то можно удалить исходники и посмотреть общий размер папки с файлами программы. Для этого нужно перейти в домашний каталог и набрать команду:
```
du -k Hello World
```
А затем  нам нужно создать файл манифеста(__control__) со следующим содержимым:
___
Package: hello
Version: 1.0
Section: unknown
Priority: optional
Architecture: amd64
Essential: no
Installed-Size: 20
Maintainer: example@mail.com
Description: Print Hello world
___

Прежде чем сделать это лучше проверить в правильной ли папке вы находитесь(Hello World - мы его уже создавали). 

Если все верно мы продолжаем.

В терминале набираем команду:
```
nano /supersh/DEBIAN/control
```
и заполняем его содержимое. Пример запонения указан  выше.

Манифест готов. Теперь нам нужно переместить файл(в нашем случае hello.py) в папку, которую мы создали раннее supersh/usr/bin.

```
mv ./hello.py supersh/usr/bin
```

####СКРИПТЫ УСТАНОВКИ
Несмотря на то, что система установки пакетов очень мощная и позволяет делать многое, некоторые вещи всё же сделать нельзя. Для решения этой проблемы была предусмотрена возможность выполнять скрипты перед установкой пакета и после. Аналогично это работает для удаления пакета - перед и после. Эти скрипты называются preinst, postinst, prerm и postrm. Каждый файл просто содержит набор скриптов, которые надо выполнить. Например:
```
nano supersh/DEBIAN/postinst
```
Заполняем содержимаое файла:
___
\#!/bin/bash
echo "Hello World installed"


___
#####Шаг 6: Сборка пакета
Осталось собрать настроенный пакет. Для этого нужно использовать команду:
```
dpkg-deb --build ./supersh
```
После завершения сборки можете установить его с помощью apt:
```
sudo apt install /hello.deb
```
После этого исполняемый файл программы появится в /usr/bin, а сообщение из postinst будет выведено после установки.